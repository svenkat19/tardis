

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>tardis.visualization.tools.sdec_plot &mdash; tardis v2021.7.12.0.dev3+g7d3899ed</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/plot_directive.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../_static/tardis_logo.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href="../../../../_static/tardis.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> tardis
          

          
          </a>

          
            
            
              <div class="version">
                2021.7.12.0.dev3+g7d3899ed
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart/quickstart.html">Quickstart for TARDIS</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Input/Output</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/configuration/index.html">Configuration (Required Input)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/optional/index.html">Optional Inputs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/visualization/index.html">Visualization Tools &amp; Widgets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../io/output/index.html">Additional Outputs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Physics Walkthrough</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/setup/index.html">Setting Up the Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/montecarlo/index.html">Monte Carlo Iteration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/est_and_conv/index.html">Estimators and Convergence</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../physics/spectrum/index.html">Spectrum Generation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Research with TARDIS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../research/index.html">Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Team &amp; Credits</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../team_and_governance/index.html">Team and Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../credits.html">Credits &amp; Publication Policies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../CODE_OF_CONDUCT.html">Code of Conduct</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../sponsors.html">Sponsors</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributing to TARDIS</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../CONTRIBUTING.html">Contribution Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../development/index.html">Developer Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../CHANGELOG.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../roadmap.html">Development Roadmap</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/modules.html">tardis</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../zreferences.html">TARDIS Papers and useful References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Outdated</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../outdated/index.html">Outdated Documentation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">tardis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>tardis.visualization.tools.sdec_plot</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for tardis.visualization.tools.sdec_plot</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Spectral element DEComposition (SDEC) Plot for TARDIS simulation models.</span>

<span class="sd">This plot is a spectral diagnostics plot similar to those originally</span>
<span class="sd">proposed by M. Kromer (see, for example, Kromer et al. 2013, figure 4).</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">astropy.modeling.blackbody</span> <span class="k">as</span> <span class="nn">abb</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">clr</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>

<span class="kn">from</span> <span class="nn">tardis.util.base</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">atomic_number2element_symbol</span><span class="p">,</span>
    <span class="n">element_symbol2atomic_number</span><span class="p">,</span>
    <span class="n">species_string_to_tuple</span><span class="p">,</span>
    <span class="n">species_tuple_to_string</span><span class="p">,</span>
    <span class="n">roman_to_int</span><span class="p">,</span>
    <span class="n">int_to_roman</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">tardis.visualization</span> <span class="kn">import</span> <span class="n">plot_util</span> <span class="k">as</span> <span class="n">pu</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="SDECData"><a class="viewcode-back" href="../../../../api/tardis.visualization.tools.sdec_plot.html#tardis.visualization.tools.sdec_plot.SDECData">[docs]</a><span class="k">class</span> <span class="nc">SDECData</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;The data of simulation model used by Spectral element DEComposition (SDEC) Plot.</span>

<span class="sd">    This preprocesses the data required by SDECPlotter class for doing</span>
<span class="sd">    calculations and plotting.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">last_interaction_type</span><span class="p">,</span>
        <span class="n">last_line_interaction_in_id</span><span class="p">,</span>
        <span class="n">last_line_interaction_out_id</span><span class="p">,</span>
        <span class="n">last_line_interaction_in_nu</span><span class="p">,</span>
        <span class="n">lines_df</span><span class="p">,</span>
        <span class="n">packet_nus</span><span class="p">,</span>
        <span class="n">packet_energies</span><span class="p">,</span>
        <span class="n">r_inner</span><span class="p">,</span>
        <span class="n">spectrum_delta_frequency</span><span class="p">,</span>
        <span class="n">spectrum_frequency_bins</span><span class="p">,</span>  <span class="c1"># stores _frequency (bin edges) not frequency</span>
        <span class="n">spectrum_luminosity_density_lambda</span><span class="p">,</span>
        <span class="n">spectrum_wavelength</span><span class="p">,</span>
        <span class="n">t_inner</span><span class="p">,</span>
        <span class="n">time_of_simulation</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the SDECData with required properties of simulation model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        last_interaction_type : np.array</span>
<span class="sd">            Interaction type (no-interaction: -1, e-scattering: 1 and</span>
<span class="sd">            line interaction: 2) values of emitted packets</span>
<span class="sd">        last_line_interaction_in_id : np.array</span>
<span class="sd">            IDs of atomic lines with which emitted packet had their last</span>
<span class="sd">            absorption (interaction in)</span>
<span class="sd">        last_line_interaction_out_id : np.array</span>
<span class="sd">            IDs of atomic lines with which emitted packet had their last</span>
<span class="sd">            emission (interaction out)</span>
<span class="sd">        last_line_interaction_in_nu : np.array</span>
<span class="sd">            Frequency values of the last absorption of emitted packets</span>
<span class="sd">        lines_df : pd.DataFrame</span>
<span class="sd">            Data about the atomic lines present in simulation model&#39;s plasma</span>
<span class="sd">        packet_nus : astropy.Quantity</span>
<span class="sd">            Frequency values of the last emission of emitted packets, having</span>
<span class="sd">            unit of Hz</span>
<span class="sd">        packet_energies : astropy.Quantity</span>
<span class="sd">            Energy values of emitted packets, having unit of erg</span>
<span class="sd">        r_inner : astropy.Quantity</span>
<span class="sd">            Radius of innermost shell, having unit of cm</span>
<span class="sd">        spectrum_delta_frequency : astropy.Quantity</span>
<span class="sd">            Frequency bin width of spectrum, having unit of Hz</span>
<span class="sd">        spectrum_frequency_bins : astropy.Quantity</span>
<span class="sd">            Frequency bin edges of spectrum, having unit of Hz</span>
<span class="sd">        spectrum_wavelength : astropy.Quantity</span>
<span class="sd">            Wavelength values of spectrum, having unit of Angstrom</span>
<span class="sd">        t_inner : astropy.Quantity</span>
<span class="sd">            Temperature of innermost shell, having unit of K</span>
<span class="sd">        time_of_simulation : astropy.Quantity</span>
<span class="sd">            Time of simulation, having unit of s (second)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Save packets properties in a dataframe for easier data manipulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">packets_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;nus&quot;</span><span class="p">:</span> <span class="n">packet_nus</span><span class="p">,</span>
                <span class="s2">&quot;lambdas&quot;</span><span class="p">:</span> <span class="n">packet_nus</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;angstrom&quot;</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">spectral</span><span class="p">()),</span>
                <span class="s2">&quot;energies&quot;</span><span class="p">:</span> <span class="n">packet_energies</span><span class="p">,</span>
                <span class="s2">&quot;last_interaction_type&quot;</span><span class="p">:</span> <span class="n">last_interaction_type</span><span class="p">,</span>
                <span class="s2">&quot;last_line_interaction_out_id&quot;</span><span class="p">:</span> <span class="n">last_line_interaction_out_id</span><span class="p">,</span>
                <span class="s2">&quot;last_line_interaction_in_id&quot;</span><span class="p">:</span> <span class="n">last_line_interaction_in_id</span><span class="p">,</span>
                <span class="s2">&quot;last_line_interaction_in_nu&quot;</span><span class="p">:</span> <span class="n">last_line_interaction_in_nu</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Save other properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines_df</span> <span class="o">=</span> <span class="n">lines_df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r_inner</span> <span class="o">=</span> <span class="n">r_inner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectrum_delta_frequency</span> <span class="o">=</span> <span class="n">spectrum_delta_frequency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectrum_frequency_bins</span> <span class="o">=</span> <span class="n">spectrum_frequency_bins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectrum_frequency</span> <span class="o">=</span> <span class="n">spectrum_frequency_bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectrum_luminosity_density_lambda</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">spectrum_luminosity_density_lambda</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectrum_wavelength</span> <span class="o">=</span> <span class="n">spectrum_wavelength</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_inner</span> <span class="o">=</span> <span class="n">t_inner</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_of_simulation</span> <span class="o">=</span> <span class="n">time_of_simulation</span>

        <span class="c1"># Create dataframe of packets that experience line interaction</span>
        <span class="n">line_mask</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">packets_df</span><span class="p">[</span><span class="s2">&quot;last_interaction_type&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">packets_df</span><span class="p">[</span><span class="s2">&quot;last_line_interaction_in_id&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">)</span>  <span class="c1"># &amp; operator is quite faster than np.logical_and on pd.Series</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">packets_df_line_interaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">packets_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">line_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Add columns for atomic number of last interaction out</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">packets_df_line_interaction</span><span class="p">[</span><span class="s2">&quot;last_line_interaction_atom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lines_df</span><span class="p">[</span><span class="s2">&quot;atomic_number&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">iloc</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">packets_df_line_interaction</span><span class="p">[</span><span class="s2">&quot;last_line_interaction_out_id&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="c1"># Add columns for the species id of last interaction</span>
        <span class="c1"># Species id is given by 100 * Z + X, where Z is atomic number and X is ion number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">packets_df_line_interaction</span><span class="p">[</span><span class="s2">&quot;last_line_interaction_species&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lines_df</span><span class="p">[</span><span class="s2">&quot;atomic_number&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">iloc</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">packets_df_line_interaction</span><span class="p">[</span><span class="s2">&quot;last_line_interaction_out_id&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="o">*</span> <span class="mi">100</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines_df</span><span class="p">[</span><span class="s2">&quot;ion_number&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">iloc</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">packets_df_line_interaction</span><span class="p">[</span><span class="s2">&quot;last_line_interaction_out_id&quot;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="p">)</span>

<div class="viewcode-block" id="SDECData.from_simulation"><a class="viewcode-back" href="../../../../api/tardis.visualization.tools.sdec_plot.html#tardis.visualization.tools.sdec_plot.SDECData.from_simulation">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_simulation</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="n">packets_mode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an instance of SDECData from a TARDIS simulation object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sim : tardis.simulation.Simulation</span>
<span class="sd">            TARDIS Simulation object produced by running a simulation</span>
<span class="sd">        packets_mode : {&#39;virtual&#39;, &#39;real&#39;}</span>
<span class="sd">            Mode of packets to be considered, either real or virtual</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        SDECData</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Properties common among both packet modes</span>
        <span class="n">lines_df</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">plasma</span><span class="o">.</span><span class="n">atomic_data</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
            <span class="s2">&quot;line_id&quot;</span>
        <span class="p">)</span>
        <span class="n">r_inner</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">r_inner</span>
        <span class="n">t_inner</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">t_inner</span>
        <span class="n">time_of_simulation</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">time_of_simulation</span>

        <span class="k">if</span> <span class="n">packets_mode</span> <span class="o">==</span> <span class="s2">&quot;virtual&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
                <span class="n">last_interaction_type</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">virt_packet_last_interaction_type</span><span class="p">,</span>
                <span class="n">last_line_interaction_in_id</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">virt_packet_last_line_interaction_in_id</span><span class="p">,</span>
                <span class="n">last_line_interaction_out_id</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">virt_packet_last_line_interaction_out_id</span><span class="p">,</span>
                <span class="n">last_line_interaction_in_nu</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">virt_packet_last_interaction_in_nu</span><span class="p">,</span>
                <span class="n">lines_df</span><span class="o">=</span><span class="n">lines_df</span><span class="p">,</span>
                <span class="n">packet_nus</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">virt_packet_nus</span><span class="p">,</span> <span class="s2">&quot;Hz&quot;</span><span class="p">),</span>
                <span class="n">packet_energies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span>
                    <span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">virt_packet_energies</span><span class="p">,</span> <span class="s2">&quot;erg&quot;</span>
                <span class="p">),</span>
                <span class="n">r_inner</span><span class="o">=</span><span class="n">r_inner</span><span class="p">,</span>
                <span class="n">spectrum_delta_frequency</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">spectrum_virtual</span><span class="o">.</span><span class="n">delta_frequency</span><span class="p">,</span>
                <span class="n">spectrum_frequency_bins</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">spectrum_virtual</span><span class="o">.</span><span class="n">_frequency</span><span class="p">,</span>
                <span class="n">spectrum_luminosity_density_lambda</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">spectrum_virtual</span><span class="o">.</span><span class="n">luminosity_density_lambda</span><span class="p">,</span>
                <span class="n">spectrum_wavelength</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">spectrum_virtual</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span>
                <span class="n">t_inner</span><span class="o">=</span><span class="n">t_inner</span><span class="p">,</span>
                <span class="n">time_of_simulation</span><span class="o">=</span><span class="n">time_of_simulation</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">elif</span> <span class="n">packets_mode</span> <span class="o">==</span> <span class="s2">&quot;real&quot;</span><span class="p">:</span>
            <span class="c1"># Packets-specific properties need to be only for those packets</span>
            <span class="c1"># which got emitted</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
                <span class="n">last_interaction_type</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">last_interaction_type</span><span class="p">[</span>
                    <span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">emitted_packet_mask</span>
                <span class="p">],</span>
                <span class="n">last_line_interaction_in_id</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">last_line_interaction_in_id</span><span class="p">[</span>
                    <span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">emitted_packet_mask</span>
                <span class="p">],</span>
                <span class="n">last_line_interaction_out_id</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">last_line_interaction_out_id</span><span class="p">[</span>
                    <span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">emitted_packet_mask</span>
                <span class="p">],</span>
                <span class="n">last_line_interaction_in_nu</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">last_interaction_in_nu</span><span class="p">[</span>
                    <span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">emitted_packet_mask</span>
                <span class="p">],</span>
                <span class="n">lines_df</span><span class="o">=</span><span class="n">lines_df</span><span class="p">,</span>
                <span class="n">packet_nus</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">output_nu</span><span class="p">[</span><span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">emitted_packet_mask</span><span class="p">],</span>
                <span class="n">packet_energies</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">output_energy</span><span class="p">[</span>
                    <span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">emitted_packet_mask</span>
                <span class="p">],</span>
                <span class="n">r_inner</span><span class="o">=</span><span class="n">r_inner</span><span class="p">,</span>
                <span class="n">spectrum_delta_frequency</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">delta_frequency</span><span class="p">,</span>
                <span class="n">spectrum_frequency_bins</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">_frequency</span><span class="p">,</span>
                <span class="n">spectrum_luminosity_density_lambda</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">luminosity_density_lambda</span><span class="p">,</span>
                <span class="n">spectrum_wavelength</span><span class="o">=</span><span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">spectrum</span><span class="o">.</span><span class="n">wavelength</span><span class="p">,</span>
                <span class="n">t_inner</span><span class="o">=</span><span class="n">t_inner</span><span class="p">,</span>
                <span class="n">time_of_simulation</span><span class="o">=</span><span class="n">time_of_simulation</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid value passed to packets_mode. Only &quot;</span>
                <span class="s2">&quot;allowed values are &#39;virtual&#39; or &#39;real&#39;&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="SDECData.from_hdf"><a class="viewcode-back" href="../../../../api/tardis.visualization.tools.sdec_plot.html#tardis.visualization.tools.sdec_plot.SDECData.from_hdf">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_hdf</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">hdf_fpath</span><span class="p">,</span> <span class="n">packets_mode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an instance of SDECData from a simulation HDF file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hdf_fpath : str</span>
<span class="sd">            Valid path to the HDF file where simulation is saved</span>
<span class="sd">        packets_mode : {&#39;virtual&#39;, &#39;real&#39;}</span>
<span class="sd">            Mode of packets to be considered, either real or virtual</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        SDECData</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">HDFStore</span><span class="p">(</span><span class="n">hdf_fpath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdf</span><span class="p">:</span>
            <span class="n">lines_df</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">hdf</span><span class="p">[</span><span class="s2">&quot;/simulation/plasma/lines&quot;</span><span class="p">]</span>
                <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;line_id&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">r_inner</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span>
                <span class="n">hdf</span><span class="p">[</span><span class="s2">&quot;/simulation/model/r_inner&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="s2">&quot;cm&quot;</span>
            <span class="p">)</span>  <span class="c1"># Convert pd.Series to np.array to construct quantity from it</span>
            <span class="n">t_inner</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">hdf</span><span class="p">[</span><span class="s2">&quot;/simulation/model/scalars&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">t_inner</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">)</span>
            <span class="n">time_of_simulation</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span>
                <span class="n">hdf</span><span class="p">[</span><span class="s2">&quot;/simulation/runner/scalars&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">time_of_simulation</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">packets_mode</span> <span class="o">==</span> <span class="s2">&quot;virtual&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
                    <span class="n">last_interaction_type</span><span class="o">=</span><span class="n">hdf</span><span class="p">[</span>
                        <span class="s2">&quot;/simulation/runner/virt_packet_last_interaction_type&quot;</span>
                    <span class="p">],</span>
                    <span class="n">last_line_interaction_in_id</span><span class="o">=</span><span class="n">hdf</span><span class="p">[</span>
                        <span class="s2">&quot;/simulation/runner/virt_packet_last_line_interaction_in_id&quot;</span>
                    <span class="p">],</span>
                    <span class="n">last_line_interaction_out_id</span><span class="o">=</span><span class="n">hdf</span><span class="p">[</span>
                        <span class="s2">&quot;/simulation/runner/virt_packet_last_line_interaction_out_id&quot;</span>
                    <span class="p">],</span>
                    <span class="n">last_line_interaction_in_nu</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span>
                        <span class="n">hdf</span><span class="p">[</span>
                            <span class="s2">&quot;/simulation/runner/virt_packet_last_interaction_in_nu&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                        <span class="s2">&quot;Hz&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">lines_df</span><span class="o">=</span><span class="n">lines_df</span><span class="p">,</span>
                    <span class="n">packet_nus</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span>
                        <span class="n">hdf</span><span class="p">[</span><span class="s2">&quot;/simulation/runner/virt_packet_nus&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                        <span class="s2">&quot;Hz&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">packet_energies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span>
                        <span class="n">hdf</span><span class="p">[</span>
                            <span class="s2">&quot;/simulation/runner/virt_packet_energies&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                        <span class="s2">&quot;erg&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">r_inner</span><span class="o">=</span><span class="n">r_inner</span><span class="p">,</span>
                    <span class="n">spectrum_delta_frequency</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span>
                        <span class="n">hdf</span><span class="p">[</span>
                            <span class="s2">&quot;/simulation/runner/spectrum_virtual/scalars&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">delta_frequency</span><span class="p">,</span>
                        <span class="s2">&quot;Hz&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">spectrum_frequency_bins</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span>
                        <span class="n">hdf</span><span class="p">[</span>
                            <span class="s2">&quot;/simulation/runner/spectrum_virtual/_frequency&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                        <span class="s2">&quot;Hz&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">spectrum_luminosity_density_lambda</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span>
                        <span class="n">hdf</span><span class="p">[</span>
                            <span class="s2">&quot;/simulation/runner/spectrum_virtual/luminosity_density_lambda&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                        <span class="s2">&quot;erg / s cm&quot;</span><span class="p">,</span>  <span class="c1"># luminosity_density_lambda is saved in hdf in CGS</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;erg / s AA&quot;</span><span class="p">),</span>
                    <span class="n">spectrum_wavelength</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span>
                        <span class="n">hdf</span><span class="p">[</span>
                            <span class="s2">&quot;/simulation/runner/spectrum_virtual/wavelength&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                        <span class="s2">&quot;cm&quot;</span><span class="p">,</span>  <span class="c1"># wavelength is saved in hdf in CGS</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;AA&quot;</span><span class="p">),</span>
                    <span class="n">t_inner</span><span class="o">=</span><span class="n">t_inner</span><span class="p">,</span>
                    <span class="n">time_of_simulation</span><span class="o">=</span><span class="n">time_of_simulation</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">elif</span> <span class="n">packets_mode</span> <span class="o">==</span> <span class="s2">&quot;real&quot;</span><span class="p">:</span>
                <span class="n">emitted_packet_mask</span> <span class="o">=</span> <span class="n">hdf</span><span class="p">[</span>
                    <span class="s2">&quot;/simulation/runner/emitted_packet_mask&quot;</span>
                <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
                    <span class="c1"># First convert series read from hdf to array before masking</span>
                    <span class="c1"># to eliminate index info which creates problems otherwise</span>
                    <span class="n">last_interaction_type</span><span class="o">=</span><span class="n">hdf</span><span class="p">[</span>
                        <span class="s2">&quot;/simulation/runner/last_interaction_type&quot;</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">emitted_packet_mask</span><span class="p">],</span>
                    <span class="n">last_line_interaction_in_id</span><span class="o">=</span><span class="n">hdf</span><span class="p">[</span>
                        <span class="s2">&quot;/simulation/runner/last_line_interaction_in_id&quot;</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">emitted_packet_mask</span><span class="p">],</span>
                    <span class="n">last_line_interaction_out_id</span><span class="o">=</span><span class="n">hdf</span><span class="p">[</span>
                        <span class="s2">&quot;/simulation/runner/last_line_interaction_out_id&quot;</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">emitted_packet_mask</span><span class="p">],</span>
                    <span class="n">last_line_interaction_in_nu</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span>
                        <span class="n">hdf</span><span class="p">[</span>
                            <span class="s2">&quot;/simulation/runner/last_interaction_in_nu&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span><span class="n">emitted_packet_mask</span><span class="p">],</span>
                        <span class="s2">&quot;Hz&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">lines_df</span><span class="o">=</span><span class="n">lines_df</span><span class="p">,</span>
                    <span class="n">packet_nus</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span>
                        <span class="n">hdf</span><span class="p">[</span><span class="s2">&quot;/simulation/runner/output_nu&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span>
                            <span class="n">emitted_packet_mask</span>
                        <span class="p">],</span>
                        <span class="s2">&quot;Hz&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">packet_energies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span>
                        <span class="n">hdf</span><span class="p">[</span><span class="s2">&quot;/simulation/runner/output_energy&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[</span>
                            <span class="n">emitted_packet_mask</span>
                        <span class="p">],</span>
                        <span class="s2">&quot;erg&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">r_inner</span><span class="o">=</span><span class="n">r_inner</span><span class="p">,</span>
                    <span class="n">spectrum_delta_frequency</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span>
                        <span class="n">hdf</span><span class="p">[</span>
                            <span class="s2">&quot;/simulation/runner/spectrum/scalars&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">delta_frequency</span><span class="p">,</span>
                        <span class="s2">&quot;Hz&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">spectrum_frequency_bins</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span>
                        <span class="n">hdf</span><span class="p">[</span>
                            <span class="s2">&quot;/simulation/runner/spectrum/_frequency&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                        <span class="s2">&quot;Hz&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">spectrum_luminosity_density_lambda</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span>
                        <span class="n">hdf</span><span class="p">[</span>
                            <span class="s2">&quot;/simulation/runner/spectrum/luminosity_density_lambda&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                        <span class="s2">&quot;erg / s cm&quot;</span><span class="p">,</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;erg / s AA&quot;</span><span class="p">),</span>
                    <span class="n">spectrum_wavelength</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span>
                        <span class="n">hdf</span><span class="p">[</span>
                            <span class="s2">&quot;/simulation/runner/spectrum/wavelength&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                        <span class="s2">&quot;cm&quot;</span><span class="p">,</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;AA&quot;</span><span class="p">),</span>
                    <span class="n">t_inner</span><span class="o">=</span><span class="n">t_inner</span><span class="p">,</span>
                    <span class="n">time_of_simulation</span><span class="o">=</span><span class="n">time_of_simulation</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid value passed to packets_mode. Only &quot;</span>
                    <span class="s2">&quot;allowed values are &#39;virtual&#39; or &#39;real&#39;&quot;</span>
                <span class="p">)</span></div></div>


<div class="viewcode-block" id="SDECPlotter"><a class="viewcode-back" href="../../../../api/tardis.visualization.tools.sdec_plot.html#tardis.visualization.tools.sdec_plot.SDECPlotter">[docs]</a><span class="k">class</span> <span class="nc">SDECPlotter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plotting interface for Spectral element DEComposition (SDEC) Plot.</span>

<span class="sd">    It performs necessary calculations to generate SDEC Plot for a simulation</span>
<span class="sd">    model, and allows to plot it in matplotlib and plotly.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the SDECPlotter with required data of simulation model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : dict of SDECData</span>
<span class="sd">            Dictionary to store data required for SDEC plot, for both packet</span>
<span class="sd">            modes i.e. real and virtual</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

<div class="viewcode-block" id="SDECPlotter.from_simulation"><a class="viewcode-back" href="../../../../api/tardis.visualization.tools.sdec_plot.html#tardis.visualization.tools.sdec_plot.SDECPlotter.from_simulation">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_simulation</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an instance of SDECPlotter from a TARDIS simulation object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sim : tardis.simulation.Simulation</span>
<span class="sd">            TARDIS Simulation object produced by running a simulation</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        SDECPlotter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sim</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">virt_logging</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">virtual</span><span class="o">=</span><span class="n">SDECData</span><span class="o">.</span><span class="n">from_simulation</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="s2">&quot;virtual&quot;</span><span class="p">),</span>
                    <span class="n">real</span><span class="o">=</span><span class="n">SDECData</span><span class="o">.</span><span class="n">from_simulation</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="s2">&quot;real&quot;</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
                <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">virtual</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">real</span><span class="o">=</span><span class="n">SDECData</span><span class="o">.</span><span class="n">from_simulation</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="s2">&quot;real&quot;</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="SDECPlotter.from_hdf"><a class="viewcode-back" href="../../../../api/tardis.visualization.tools.sdec_plot.html#tardis.visualization.tools.sdec_plot.SDECPlotter.from_hdf">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_hdf</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">hdf_fpath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an instance of SDECPlotter from a simulation HDF file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hdf_fpath : str</span>
<span class="sd">            Valid path to the HDF file where simulation is saved</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        SDECPlotter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">virtual</span><span class="o">=</span><span class="n">SDECData</span><span class="o">.</span><span class="n">from_hdf</span><span class="p">(</span><span class="n">hdf_fpath</span><span class="p">,</span> <span class="s2">&quot;virtual&quot;</span><span class="p">),</span>
                <span class="n">real</span><span class="o">=</span><span class="n">SDECData</span><span class="o">.</span><span class="n">from_hdf</span><span class="p">(</span><span class="n">hdf_fpath</span><span class="p">,</span> <span class="s2">&quot;real&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_parse_species_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">species_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse user requested species list and create list of species ids to be used.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        species_list : list of species to plot</span>
<span class="sd">            List of species (e.g. Si II, Ca II, etc.) that the user wants to show as unique colours.</span>
<span class="sd">            Species can be given as an ion (e.g. Si II), an element (e.g. Si), a range of ions</span>
<span class="sd">            (e.g. Si I - V), or any combination of these (e.g. species_list = [Si II, Fe I-V, Ca])</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">species_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># check if there are any digits in the species list. If there are, then exit.</span>
            <span class="c1"># species_list should only contain species in the Roman numeral</span>
            <span class="c1"># format, e.g. Si II, and each ion must contain a space</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">char</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">species_list</span><span class="p">))</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;All species must be in Roman numeral form, e.g. Si II&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">full_species_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">species_list</span><span class="p">:</span>
                    <span class="c1"># check if a hyphen is present. If it is, then it indicates a</span>
                    <span class="c1"># range of ions. Add each ion in that range to the list as a new entry</span>
                    <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">species</span><span class="p">:</span>
                        <span class="c1"># split the string on spaces. First thing in the list is then the element</span>
                        <span class="n">element</span> <span class="o">=</span> <span class="n">species</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1"># Next thing is the ion range</span>
                        <span class="c1"># convert the requested ions into numerals</span>
                        <span class="n">first_ion_numeral</span> <span class="o">=</span> <span class="n">roman_to_int</span><span class="p">(</span>
                            <span class="n">species</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="n">second_ion_numeral</span> <span class="o">=</span> <span class="n">roman_to_int</span><span class="p">(</span>
                            <span class="n">species</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="p">)</span>
                        <span class="c1"># add each ion between the two requested into the species list</span>
                        <span class="k">for</span> <span class="n">ion_number</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                            <span class="n">first_ion_numeral</span><span class="p">,</span> <span class="n">second_ion_numeral</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="p">):</span>
                            <span class="n">full_species_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">element</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">int_to_roman</span><span class="p">(</span><span class="n">ion_number</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Otherwise it&#39;s either an element or ion so just add to the list</span>
                        <span class="n">full_species_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>

                <span class="c1"># full_species_list is now a list containing each individual species requested</span>
                <span class="c1"># e.g. it parses species_list = [Si I - V] into species_list = [Si I, Si II, Si III, Si IV, Si V]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_full_species_list</span> <span class="o">=</span> <span class="n">full_species_list</span>
                <span class="n">requested_species_ids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">keep_colour</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># go through each of the requested species. Check whether it is</span>
                <span class="c1"># an element or ion (ions have spaces). If it is an element,</span>
                <span class="c1"># add all possible ions to the ions list. Otherwise just add</span>
                <span class="c1"># the requested ion</span>
                <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="n">full_species_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot; &quot;</span> <span class="ow">in</span> <span class="n">species</span><span class="p">:</span>
                        <span class="n">requested_species_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">species_string_to_tuple</span><span class="p">(</span><span class="n">species</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>
                                <span class="o">+</span> <span class="n">species_string_to_tuple</span><span class="p">(</span><span class="n">species</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">atomic_number</span> <span class="o">=</span> <span class="n">element_symbol2atomic_number</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>
                        <span class="n">requested_species_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">atomic_number</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">ion_number</span>
                                <span class="k">for</span> <span class="n">ion_number</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                        <span class="c1"># add the atomic number to a list so you know that this element should</span>
                        <span class="c1"># have all species in the same colour, i.e. it was requested like</span>
                        <span class="c1"># species_list = [Si]</span>
                        <span class="n">keep_colour</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)</span>
                <span class="n">requested_species_ids</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">species_id</span>
                    <span class="k">for</span> <span class="n">temp_list</span> <span class="ow">in</span> <span class="n">requested_species_ids</span>
                    <span class="k">for</span> <span class="n">species_id</span> <span class="ow">in</span> <span class="n">temp_list</span>
                <span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_species_list</span> <span class="o">=</span> <span class="n">requested_species_ids</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_keep_colour</span> <span class="o">=</span> <span class="n">keep_colour</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_species_list</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_calculate_plotting_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">packets_mode</span><span class="p">,</span> <span class="n">packet_wvl_range</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">nelements</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate data to be used in plotting based on parameters passed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        packets_mode : {&#39;virtual&#39;, &#39;real&#39;}</span>
<span class="sd">            Mode of packets to be considered, either real or virtual</span>
<span class="sd">        packet_wvl_range : astropy.Quantity</span>
<span class="sd">            Wavelength range to restrict the analysis of escaped packets. It</span>
<span class="sd">            should be a quantity having units of Angstrom, containing two</span>
<span class="sd">            values - lower lambda and upper lambda i.e.</span>
<span class="sd">            [lower_lambda, upper_lambda] * u.AA</span>
<span class="sd">        distance : astropy.Quantity</span>
<span class="sd">            Distance used to calculate flux instead of luminosity in the plot.</span>
<span class="sd">            It should have a length unit like m, Mpc, etc.</span>
<span class="sd">        nelements: int</span>
<span class="sd">            Number of elements to include in plot. Determined by the</span>
<span class="sd">            largest contribution to the total luminosity absorbed and emitted.</span>
<span class="sd">            Other elements are shown in silver. Default value is</span>
<span class="sd">            None, which displays all elements</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        It doesn&#39;t return the calculated properties but save them in instance</span>
<span class="sd">        itself. So it should be always called before starting plotting to</span>
<span class="sd">        update the plotting data based on parameters passed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">packets_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;virtual&quot;</span><span class="p">,</span> <span class="s2">&quot;real&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid value passed to packets_mode. Only &quot;</span>
                <span class="s2">&quot;allowed values are &#39;virtual&#39; or &#39;real&#39;&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">packets_mode</span> <span class="o">==</span> <span class="s2">&quot;virtual&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;SDECPlotter doesn&#39;t have any data for virtual packets population and SDEC &quot;</span>
                <span class="s2">&quot;plot for the same was requested. Either set virtual_packet_logging: True &quot;</span>
                <span class="s2">&quot;in your configuration file to generate SDEC plot with virtual packets, or &quot;</span>
                <span class="s2">&quot;pass packets_mode=&#39;real&#39; in your function call to generate SDEC plot with &quot;</span>
                <span class="s2">&quot;real packets.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Store the plottable range of each spectrum property which is</span>
        <span class="c1"># same as entire range, initially</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_frequency_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
            <span class="n">packets_mode</span>
        <span class="p">]</span><span class="o">.</span><span class="n">spectrum_frequency_bins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">spectrum_wavelength</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_frequency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">spectrum_frequency</span>

        <span class="c1"># Filter their plottable range based on packet_wvl_range specified</span>
        <span class="k">if</span> <span class="n">packet_wvl_range</span><span class="p">:</span>
            <span class="n">packet_nu_range</span> <span class="o">=</span> <span class="n">packet_wvl_range</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;Hz&quot;</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">spectral</span><span class="p">())</span>

            <span class="c1"># Index of value just before the 1st value that is &gt; packet_nu_range[1]</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_frequency_bins</span> <span class="o">&gt;</span> <span class="n">packet_nu_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">)</span>
            <span class="c1"># Index of value just after the last value that is &lt; packet_nu_range[0]</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_frequency_bins</span> <span class="o">&lt;</span> <span class="n">packet_nu_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_frequency_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_frequency_bins</span><span class="p">[</span>
                <span class="n">start_idx</span> <span class="p">:</span> <span class="n">end_idx</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">]</span>

            <span class="c1"># Since spectrum frequency (&amp; hence wavelength) were created from</span>
            <span class="c1"># frequency_bins[:-1], so we exclude end_idx when creating the mask</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">packet_wvl_range_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">packet_wvl_range_mask</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">packet_wvl_range_mask</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_frequency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_frequency</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">packet_wvl_range_mask</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">packet_wvl_range_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span>
            <span class="p">)</span>

        <span class="c1"># Make sure number of bin edges are always one more than wavelengths</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_frequency_bins</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># Calculate the area term to convert luminosity to flux</span>
        <span class="k">if</span> <span class="n">distance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lum_to_flux</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># so that this term will have no effect</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;distance passed must be greater than 0. If you intended &quot;</span>
                    <span class="s2">&quot;to plot luminosities instead of flux, set distance=None &quot;</span>
                    <span class="s2">&quot;or don&#39;t specify distance parameter in the function call.&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lum_to_flux</span> <span class="o">=</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">distance</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cm&quot;</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="c1"># Calculate luminosities to be shown in plot</span>
        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emission_species</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_emission_luminosities</span><span class="p">(</span>
            <span class="n">packets_mode</span><span class="o">=</span><span class="n">packets_mode</span><span class="p">,</span> <span class="n">packet_wvl_range</span><span class="o">=</span><span class="n">packet_wvl_range</span>
        <span class="p">)</span>
        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">absorption_luminosities_df</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">absorption_species</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_absorption_luminosities</span><span class="p">(</span>
            <span class="n">packets_mode</span><span class="o">=</span><span class="n">packets_mode</span><span class="p">,</span> <span class="n">packet_wvl_range</span><span class="o">=</span><span class="n">packet_wvl_range</span>
        <span class="p">)</span>

        <span class="c1"># Calculate the total contribution of elements</span>
        <span class="c1"># by summing absorption and emission</span>
        <span class="c1"># Only care about elements, so drop no interaction and electron scattering</span>
        <span class="c1"># contributions from the emitted luminosities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_luminosities_df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">absorption_luminosities_df</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;noint&quot;</span><span class="p">,</span> <span class="s2">&quot;escatter&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Sort the element list based on the total contribution</span>
        <span class="n">sorted_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_luminosities_df</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
            <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># If nelements and species_list are not included, the list of elements is just all elements</span>
        <span class="k">if</span> <span class="n">nelements</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_species_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_luminosities_df</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_species_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Compare the species present in the model to those in the requested list</span>
            <span class="c1"># Mask out those that aren&#39;t in the model</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">sorted_list</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_species_list</span>
            <span class="p">)</span>
            <span class="c1"># If species_list is included then create a new column which is the sum</span>
            <span class="c1"># of all other species i.e. those that aren&#39;t in the requested list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">total_luminosities_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">column</span><span class="o">=</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">total_luminosities_df</span><span class="p">[</span><span class="n">sorted_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="o">~</span><span class="n">mask</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="c1"># Then drop all of the individual columns for species included in &#39;other&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">total_luminosities_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                <span class="n">sorted_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="c1"># Repeat this for the emission and absorption dfs</span>
            <span class="c1"># This will require creating a temporary list that includes &#39;noint&#39; and &#39;escatter&#39;</span>
            <span class="c1"># packets, because you don&#39;t want them dropped or included in &#39;other&#39;</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">species</span> <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_species_list</span><span class="p">]</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;noint&quot;</span><span class="p">)</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;escatter&quot;</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span> <span class="n">temp</span>
            <span class="p">)</span>
            <span class="c1"># If species_list is included then create a new column which is the sum</span>
            <span class="c1"># of all other species i.e. those that aren&#39;t in the requested list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">column</span><span class="o">=</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="c1"># Need to add a new value to the mask array for the &#39;other&#39; column just added</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Then drop all of the individual columns for species included in &#39;other&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span>
                <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">species</span> <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_species_list</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">absorption_luminosities_df</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span> <span class="n">temp</span>
            <span class="p">)</span>
            <span class="c1"># If species_list is included then create a new column which is the sum</span>
            <span class="c1"># of all other species i.e. those that aren&#39;t in the requested list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">absorption_luminosities_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">column</span><span class="o">=</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">absorption_luminosities_df</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">absorption_luminosities_df</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="c1"># Need to add a new value to the mask array for the &#39;other&#39; column just added</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Then drop all of the individual columns for species included in &#39;other&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">absorption_luminosities_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">absorption_luminosities_df</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="o">~</span><span class="n">mask</span><span class="p">],</span>
                <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Get the list of species in the model</span>
            <span class="c1"># Index from 1: to avoid the &#39;other&#39; column</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_luminosities_df</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If nelements is included then create a new column which is the sum</span>
            <span class="c1"># of all other elements, i.e. those that aren&#39;t in the top contributing nelements</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">total_luminosities_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">column</span><span class="o">=</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">total_luminosities_df</span><span class="p">[</span>
                    <span class="n">sorted_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">nelements</span><span class="p">:]</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="c1"># Then drop all of the individual columns for elements included in &#39;other&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">total_luminosities_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                <span class="n">sorted_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">nelements</span><span class="p">:],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="c1"># If nelements is included then create a new column which is the sum</span>
            <span class="c1"># of all other elements, i.e. those that aren&#39;t in the top contributing nelements</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">column</span><span class="o">=</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="p">[</span>
                    <span class="n">sorted_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">nelements</span><span class="p">:]</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="c1"># Then drop all of the individual columns for elements included in &#39;other&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                <span class="n">sorted_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">nelements</span><span class="p">:],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="c1"># If nelements is included then create a new column which is the sum</span>
            <span class="c1"># of all other elements, i.e. those that aren&#39;t in the top contributing nelements</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">absorption_luminosities_df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">column</span><span class="o">=</span><span class="s2">&quot;other&quot;</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">absorption_luminosities_df</span><span class="p">[</span>
                    <span class="n">sorted_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">nelements</span><span class="p">:]</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="c1"># Then drop all of the individual columns for elements included in &#39;other&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">absorption_luminosities_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                <span class="n">sorted_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="n">nelements</span><span class="p">:],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="c1"># Get the list of species in the model</span>
            <span class="c1"># Index from 1: to avoid the &#39;other&#39; column</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">total_luminosities_df</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">photosphere_luminosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_photosphere_luminosity</span><span class="p">(</span>
            <span class="n">packets_mode</span><span class="o">=</span><span class="n">packets_mode</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modeled_spectrum_luminosity</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">spectrum_luminosity_density_lambda</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">packet_wvl_range_mask</span>
            <span class="p">]</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">lum_to_flux</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calculate_emission_luminosities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packets_mode</span><span class="p">,</span> <span class="n">packet_wvl_range</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate luminosities for the emission part of SDEC plot.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        packets_mode : {&#39;virtual&#39;, &#39;real&#39;}</span>
<span class="sd">            Mode of packets to be considered, either real or virtual</span>
<span class="sd">        packet_wvl_range : astropy.Quantity</span>
<span class="sd">            Wavelength range to restrict the analysis of escaped packets. It</span>
<span class="sd">            should be a quantity having units of Angstrom, containing two</span>
<span class="sd">            values - lower lambda and upper lambda i.e.</span>
<span class="sd">            [lower_lambda, upper_lambda] * u.AA</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        luminosities_df : pd.DataFrame</span>
<span class="sd">            Dataframe containing luminosities contributed by no interaction,</span>
<span class="sd">            only e-scattering and emission with each element present</span>
<span class="sd">        elements_present: np.array</span>
<span class="sd">            Atomic numbers of the elements with which packets of specified</span>
<span class="sd">            wavelength range interacted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate masks to be applied on packets data based on packet_wvl_range</span>
        <span class="k">if</span> <span class="n">packet_wvl_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">packet_nu_range_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">packets_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">packet_nu_line_range_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">packets_df_line_interaction</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">packet_nu_range</span> <span class="o">=</span> <span class="n">packet_wvl_range</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;Hz&quot;</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">spectral</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">packet_nu_range_mask</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">packets_df</span><span class="p">[</span><span class="s2">&quot;nus&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">packet_nu_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">packets_df</span><span class="p">[</span><span class="s2">&quot;nus&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">packet_nu_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">packet_nu_line_range_mask</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">packets_df_line_interaction</span><span class="p">[</span><span class="s2">&quot;nus&quot;</span><span class="p">]</span>
                <span class="o">&lt;</span> <span class="n">packet_nu_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">packets_df_line_interaction</span><span class="p">[</span><span class="s2">&quot;nus&quot;</span><span class="p">]</span>
                <span class="o">&gt;</span> <span class="n">packet_nu_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># Histogram weights are packet luminosities or flux</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">packets_df</span><span class="p">[</span><span class="s2">&quot;energies&quot;</span><span class="p">][</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">packet_nu_range_mask</span>
            <span class="p">]</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">lum_to_flux</span>
        <span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">time_of_simulation</span>

        <span class="n">luminosities_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span><span class="p">)</span>

        <span class="c1"># Contribution of packets which experienced no interaction ------------</span>
        <span class="c1"># Mask to select packets with no interaction</span>
        <span class="n">mask_noint</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">packets_df</span><span class="p">[</span><span class="s2">&quot;last_interaction_type&quot;</span><span class="p">][</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">packet_nu_range_mask</span>
            <span class="p">]</span>
            <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">)</span>

        <span class="c1"># Calculate weighted histogram of packet frequencies for</span>
        <span class="c1"># plottable range of frequency bins</span>
        <span class="n">hist_noint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">packets_df</span><span class="p">[</span><span class="s2">&quot;nus&quot;</span><span class="p">][</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">packet_nu_range_mask</span>
            <span class="p">][</span><span class="n">mask_noint</span><span class="p">],</span>
            <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_frequency_bins</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="n">mask_noint</span><span class="p">],</span>
            <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Convert histogram (luminosity values) to luminosity density lambda</span>
        <span class="n">L_nu_noint</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">hist_noint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">erg</span>
            <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">spectrum_delta_frequency</span>
        <span class="p">)</span>
        <span class="n">L_lambda_noint</span> <span class="o">=</span> <span class="n">L_nu_noint</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_frequency</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span>

        <span class="c1"># Save it in df</span>
        <span class="n">luminosities_df</span><span class="p">[</span><span class="s2">&quot;noint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">L_lambda_noint</span><span class="o">.</span><span class="n">value</span>

        <span class="c1"># Contribution of packets which only experienced electron scattering ---</span>
        <span class="n">mask_escatter</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">packets_df</span><span class="p">[</span><span class="s2">&quot;last_interaction_type&quot;</span><span class="p">][</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">packet_nu_range_mask</span>
            <span class="p">]</span>
            <span class="o">==</span> <span class="mi">1</span>
        <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">packets_df</span><span class="p">[</span><span class="s2">&quot;last_line_interaction_in_id&quot;</span><span class="p">][</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">packet_nu_range_mask</span>
            <span class="p">]</span>
            <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">hist_escatter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">packets_df</span><span class="p">[</span><span class="s2">&quot;nus&quot;</span><span class="p">][</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">packet_nu_range_mask</span>
            <span class="p">][</span><span class="n">mask_escatter</span><span class="p">],</span>
            <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_frequency_bins</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">[</span><span class="n">mask_escatter</span><span class="p">],</span>
            <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">L_nu_escatter</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">hist_escatter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">erg</span>
            <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">spectrum_delta_frequency</span>
        <span class="p">)</span>
        <span class="n">L_lambda_escatter</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">L_nu_escatter</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_frequency</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span>
        <span class="p">)</span>
        <span class="n">luminosities_df</span><span class="p">[</span><span class="s2">&quot;escatter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">L_lambda_escatter</span><span class="o">.</span><span class="n">value</span>

        <span class="c1"># Group packets_df by atomic number of elements with which packets</span>
        <span class="c1"># had their last emission (interaction out)</span>
        <span class="c1"># or if species_list is requested then group by species id</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_species_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">packets_df_grouped</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span>
                <span class="o">.</span><span class="n">packets_df_line_interaction</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">packet_nu_line_range_mask</span><span class="p">]</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;last_line_interaction_atom&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">packets_df_grouped</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span>
                <span class="o">.</span><span class="n">packets_df_line_interaction</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">packet_nu_line_range_mask</span><span class="p">]</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;last_line_interaction_species&quot;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Contribution of each species with which packets interacted ----------</span>
        <span class="k">for</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">packets_df_grouped</span><span class="p">:</span>
            <span class="c1"># Histogram of specific species</span>
            <span class="n">hist_el</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
                <span class="n">group</span><span class="p">[</span><span class="s2">&quot;nus&quot;</span><span class="p">],</span>
                <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_frequency_bins</span><span class="p">,</span>
                <span class="n">weights</span><span class="o">=</span><span class="n">group</span><span class="p">[</span><span class="s2">&quot;energies&quot;</span><span class="p">]</span>
                <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">lum_to_flux</span>
                <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">time_of_simulation</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Convert to luminosity density lambda</span>
            <span class="n">L_nu_el</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">hist_el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">erg</span>
                <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>
                <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">spectrum_delta_frequency</span>
            <span class="p">)</span>
            <span class="n">L_lambda_el</span> <span class="o">=</span> <span class="n">L_nu_el</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_frequency</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span>

            <span class="n">luminosities_df</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">L_lambda_el</span><span class="o">.</span><span class="n">value</span>

        <span class="c1"># Create an array of the species with which packets interacted</span>
        <span class="n">emission_species_present</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">packets_df_grouped</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">luminosities_df</span><span class="p">,</span> <span class="n">emission_species_present</span>

    <span class="k">def</span> <span class="nf">_calculate_absorption_luminosities</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">packets_mode</span><span class="p">,</span> <span class="n">packet_wvl_range</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate luminosities for the absorption part of SDEC plot.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        packets_mode : {&#39;virtual&#39;, &#39;real&#39;}</span>
<span class="sd">            Mode of packets to be considered, either real or virtual</span>
<span class="sd">        packet_wvl_range : astropy.Quantity</span>
<span class="sd">            Wavelength range to restrict the analysis of escaped packets. It</span>
<span class="sd">            should be a quantity having units of Angstrom, containing two</span>
<span class="sd">            values - lower lambda and upper lambda i.e.</span>
<span class="sd">            [lower_lambda, upper_lambda] * u.AA</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            Dataframe containing luminosities contributed by absorption with</span>
<span class="sd">            each element present</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate masks to be applied on packets data based on packet_wvl_range</span>
        <span class="k">if</span> <span class="n">packet_wvl_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">packet_nu_line_range_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">packets_df_line_interaction</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">packet_nu_range</span> <span class="o">=</span> <span class="n">packet_wvl_range</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;Hz&quot;</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">spectral</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">packet_nu_line_range_mask</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">packets_df_line_interaction</span><span class="p">[</span>
                    <span class="s2">&quot;last_line_interaction_in_nu&quot;</span>
                <span class="p">]</span>
                <span class="o">&lt;</span> <span class="n">packet_nu_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">packets_df_line_interaction</span><span class="p">[</span>
                    <span class="s2">&quot;last_line_interaction_in_nu&quot;</span>
                <span class="p">]</span>
                <span class="o">&gt;</span> <span class="n">packet_nu_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="n">luminosities_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span><span class="p">)</span>

        <span class="c1"># Group packets_df by atomic number of elements with which packets</span>
        <span class="c1"># had their last absorption (interaction in)</span>
        <span class="c1"># or if species_list is requested then group by species id</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_species_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">packets_df_grouped</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span>
                <span class="o">.</span><span class="n">packets_df_line_interaction</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">packet_nu_line_range_mask</span><span class="p">]</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;last_line_interaction_atom&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">packets_df_grouped</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span>
                <span class="o">.</span><span class="n">packets_df_line_interaction</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">packet_nu_line_range_mask</span><span class="p">]</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;last_line_interaction_species&quot;</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">identifier</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">packets_df_grouped</span><span class="p">:</span>
            <span class="c1"># Histogram of specific species</span>
            <span class="n">hist_el</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
                <span class="n">group</span><span class="p">[</span><span class="s2">&quot;last_line_interaction_in_nu&quot;</span><span class="p">],</span>
                <span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_frequency_bins</span><span class="p">,</span>
                <span class="n">weights</span><span class="o">=</span><span class="n">group</span><span class="p">[</span><span class="s2">&quot;energies&quot;</span><span class="p">]</span>
                <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">lum_to_flux</span>
                <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">time_of_simulation</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Convert to luminosity density lambda</span>
            <span class="n">L_nu_el</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">hist_el</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">erg</span>
                <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>
                <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">spectrum_delta_frequency</span>
            <span class="p">)</span>
            <span class="n">L_lambda_el</span> <span class="o">=</span> <span class="n">L_nu_el</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_frequency</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span>

            <span class="n">luminosities_df</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">L_lambda_el</span><span class="o">.</span><span class="n">value</span>

        <span class="n">absorption_species_present</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">packets_df_grouped</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">luminosities_df</span><span class="p">,</span> <span class="n">absorption_species_present</span>

    <span class="k">def</span> <span class="nf">_calculate_photosphere_luminosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">packets_mode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate blackbody luminosity of the photosphere.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        packets_mode : {&#39;virtual&#39;, &#39;real&#39;}</span>
<span class="sd">            Mode of packets to be considered, either real or virtual</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        astropy.Quantity</span>
<span class="sd">            Luminosity density lambda (or Flux) of photosphere (inner boundary</span>
<span class="sd">            of TARDIS simulation)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">L_lambda_ph</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">abb</span><span class="o">.</span><span class="n">blackbody_lambda</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">t_inner</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="mi">4</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">packets_mode</span><span class="p">]</span><span class="o">.</span><span class="n">r_inner</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">sr</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;erg / (AA s)&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">L_lambda_ph</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">lum_to_flux</span>

<div class="viewcode-block" id="SDECPlotter.generate_plot_mpl"><a class="viewcode-back" href="../../../../api/tardis.visualization.tools.sdec_plot.html#tardis.visualization.tools.sdec_plot.SDECPlotter.generate_plot_mpl">[docs]</a>    <span class="k">def</span> <span class="nf">generate_plot_mpl</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">packets_mode</span><span class="o">=</span><span class="s2">&quot;virtual&quot;</span><span class="p">,</span>
        <span class="n">packet_wvl_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">show_modeled_spectrum</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
        <span class="n">cmapname</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span>
        <span class="n">nelements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">species_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate Spectral element DEComposition (SDEC) Plot using matplotlib.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        packets_mode : {&#39;virtual&#39;, &#39;real&#39;}, optional</span>
<span class="sd">            Mode of packets to be considered, either real or virtual. Default</span>
<span class="sd">            value is &#39;virtual&#39;</span>
<span class="sd">        packet_wvl_range : astropy.Quantity or None, optional</span>
<span class="sd">            Wavelength range to restrict the analysis of escaped packets. It</span>
<span class="sd">            should be a quantity having units of Angstrom, containing two</span>
<span class="sd">            values - lower lambda and upper lambda i.e.</span>
<span class="sd">            [lower_lambda, upper_lambda] * u.AA. Default value is None</span>
<span class="sd">        distance : astropy.Quantity or None, optional</span>
<span class="sd">            Distance used to calculate flux instead of luminosity in the plot.</span>
<span class="sd">            It should have a length unit like m, Mpc, etc. Default value is None</span>
<span class="sd">        show_modeled_spectrum : bool, optional</span>
<span class="sd">            Whether to show modeled spectrum in SDEC Plot. Default value is</span>
<span class="sd">            True</span>
<span class="sd">        ax : matplotlib.axes._subplots.AxesSubplot or None, optional</span>
<span class="sd">            Axis on which to create plot. Default value is None which will</span>
<span class="sd">            create plot on a new figure&#39;s axis.</span>
<span class="sd">        figsize : tuple, optional</span>
<span class="sd">            Size of the matplotlib figure to display. Default value is (12, 7)</span>
<span class="sd">        cmapname : str, optional</span>
<span class="sd">            Name of matplotlib colormap to be used for showing elements.</span>
<span class="sd">            Default value is &quot;jet&quot;</span>
<span class="sd">        nelements: int</span>
<span class="sd">            Number of elements to include in plot. Determined by the</span>
<span class="sd">            largest contribution to total luminosity absorbed and emitted.</span>
<span class="sd">            Other elements are shown in silver. Default value is</span>
<span class="sd">            None, which displays all elements</span>
<span class="sd">        species_list: list of strings or None</span>
<span class="sd">            list of strings containing the names of species that should be included in the SDEC plots.</span>
<span class="sd">            Must be given in Roman numeral format. Can include specific ions, a range of ions,</span>
<span class="sd">            individual elements, or any combination of these:</span>
<span class="sd">            e.g. [&#39;Si II&#39;, &#39;Ca II&#39;, &#39;C&#39;, &#39;Fe I-V&#39;]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        matplotlib.axes._subplots.AxesSubplot</span>
<span class="sd">            Axis on which SDEC Plot is created</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># If species_list and nelements requested, tell user that nelements is ignored</span>
        <span class="k">if</span> <span class="n">species_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nelements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Both nelements and species_list were requested. Species_list takes priority; nelements is ignored&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Parse the requested species list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_species_list</span><span class="p">(</span><span class="n">species_list</span><span class="o">=</span><span class="n">species_list</span><span class="p">)</span>

        <span class="c1"># Calculate data attributes required for plotting</span>
        <span class="c1"># and save them in instance itself</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_plotting_data</span><span class="p">(</span>
            <span class="n">packets_mode</span><span class="o">=</span><span class="n">packets_mode</span><span class="p">,</span>
            <span class="n">packet_wvl_range</span><span class="o">=</span><span class="n">packet_wvl_range</span><span class="p">,</span>
            <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
            <span class="n">nelements</span><span class="o">=</span><span class="n">nelements</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span>

        <span class="c1"># Get the labels in the color bar. This determines the number of unique colors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_colorbar_labels</span><span class="p">()</span>
        <span class="c1"># Set colormap to be used in elements of emission and absorption plots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmapname</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_species_name</span><span class="p">))</span>
        <span class="c1"># Get the number of unqie colors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_colorbar_colors</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_colorbar_mpl</span><span class="p">()</span>

        <span class="c1"># Plot emission and absorption components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_emission_mpl</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_absorption_mpl</span><span class="p">()</span>

        <span class="c1"># Plot modeled spectrum</span>
        <span class="k">if</span> <span class="n">show_modeled_spectrum</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">modeled_spectrum_luminosity</span><span class="p">,</span>
                <span class="s2">&quot;--b&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">packets_mode</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> Spectrum&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Plot photosphere</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">photosphere_luminosity</span><span class="p">,</span>
            <span class="s2">&quot;--r&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Blackbody Photosphere&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Set legends and labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength $[\mathrm{\AA}]$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">distance</span><span class="p">:</span>  <span class="c1"># Set y-axis label for flux</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
                <span class="sa">r</span><span class="s2">&quot;$F_{\lambda}$ [erg $\mathrm{s^{-1}}$ $\mathrm{cm^{-2}}$ $\mathrm{\AA^{-1}}$]&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Set y-axis label for luminosity</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
                <span class="sa">r</span><span class="s2">&quot;$L_{\lambda}$ [erg $\mathrm{s^{-1}}$ $\mathrm{\AA^{-1}}$]&quot;</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_plot_emission_mpl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot emission part of the SDEC Plot using matplotlib.&quot;&quot;&quot;</span>
        <span class="c1"># To create stacked area chart in matplotlib, we will start with zero</span>
        <span class="c1"># lower level and will keep adding luminosities to it (upper level)</span>
        <span class="n">lower_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">upper_level</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">lower_level</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="o">.</span><span class="n">noint</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span><span class="p">,</span>
            <span class="n">lower_level</span><span class="p">,</span>
            <span class="n">upper_level</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;No interaction&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">lower_level</span> <span class="o">=</span> <span class="n">upper_level</span>
        <span class="n">upper_level</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">lower_level</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="o">.</span><span class="n">escatter</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span><span class="p">,</span>
            <span class="n">lower_level</span><span class="p">,</span>
            <span class="n">upper_level</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Electron Scatter Only&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># If the &#39;other&#39; column exists then plot it as silver</span>
        <span class="k">if</span> <span class="s2">&quot;other&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">lower_level</span> <span class="o">=</span> <span class="n">upper_level</span>
            <span class="n">upper_level</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">lower_level</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="o">.</span><span class="n">other</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span><span class="p">,</span>
                <span class="n">lower_level</span><span class="p">,</span>
                <span class="n">upper_level</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;silver&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Other elements&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Contribution from each element</span>
        <span class="k">for</span> <span class="n">species_counter</span><span class="p">,</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lower_level</span> <span class="o">=</span> <span class="n">upper_level</span>
                <span class="n">upper_level</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">lower_level</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span><span class="p">,</span>
                    <span class="n">lower_level</span><span class="p">,</span>
                    <span class="n">upper_level</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_color_list</span><span class="p">[</span><span class="n">species_counter</span><span class="p">],</span>
                    <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># Add notifications that this species was not in the emission df</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_species_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atomic_number2element_symbol</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; is not in the emitted packets; skipping&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Get the ion number and atomic number for each species</span>
                    <span class="n">ion_number</span> <span class="o">=</span> <span class="n">identifier</span> <span class="o">%</span> <span class="mi">100</span>
                    <span class="n">atomic_number</span> <span class="o">=</span> <span class="p">(</span><span class="n">identifier</span> <span class="o">-</span> <span class="n">ion_number</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atomic_number2element_symbol</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">int_to_roman</span><span class="p">(</span><span class="n">ion_number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; is not in the emitted packets; skipping&quot;</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_plot_absorption_mpl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot absorption part of the SDEC Plot using matplotlib.&quot;&quot;&quot;</span>
        <span class="n">lower_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">absorption_luminosities_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># To plot absorption part along -ve X-axis, we will start with</span>
        <span class="c1"># zero upper level and keep subtracting luminosities to it (lower</span>
        <span class="c1"># level) - fill from upper to lower level</span>
        <span class="c1"># If the &#39;other&#39; column exists then plot it as silver</span>
        <span class="k">if</span> <span class="s2">&quot;other&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">absorption_luminosities_df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">upper_level</span> <span class="o">=</span> <span class="n">lower_level</span>
            <span class="n">lower_level</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">upper_level</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">absorption_luminosities_df</span><span class="o">.</span><span class="n">other</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span><span class="p">,</span>
                <span class="n">upper_level</span><span class="p">,</span>
                <span class="n">lower_level</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;silver&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">species_counter</span><span class="p">,</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">upper_level</span> <span class="o">=</span> <span class="n">lower_level</span>
                <span class="n">lower_level</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">upper_level</span>
                    <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">absorption_luminosities_df</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span><span class="p">,</span>
                    <span class="n">upper_level</span><span class="p">,</span>
                    <span class="n">lower_level</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_color_list</span><span class="p">[</span><span class="n">species_counter</span><span class="p">],</span>
                    <span class="n">cmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># Add notifications that this species was not in the emission df</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_species_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atomic_number2element_symbol</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; is not in the absorbed packets; skipping&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Get the ion number and atomic number for each species</span>
                    <span class="n">ion_number</span> <span class="o">=</span> <span class="n">identifier</span> <span class="o">%</span> <span class="mi">100</span>
                    <span class="n">atomic_number</span> <span class="o">=</span> <span class="p">(</span><span class="n">identifier</span> <span class="o">-</span> <span class="n">ion_number</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atomic_number2element_symbol</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">int_to_roman</span><span class="p">(</span><span class="n">ion_number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; is not in the absorbed packets; skipping&quot;</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_show_colorbar_mpl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show matplotlib colorbar with labels of elements mapped to colors.&quot;&quot;&quot;</span>

        <span class="n">color_values</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">(</span><span class="n">species_counter</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_species_name</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">species_counter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_species_name</span><span class="p">))</span>
        <span class="p">]</span>

        <span class="n">custcmap</span> <span class="o">=</span> <span class="n">clr</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span><span class="n">color_values</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">clr</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_species_name</span><span class="p">))</span>
        <span class="n">mappable</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">custcmap</span><span class="p">)</span>
        <span class="n">mappable</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_species_name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mappable</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ax</span><span class="p">)</span>

        <span class="n">bounds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_species_name</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span>

        <span class="n">cbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_species_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_colorbar_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the labels for the species in the colorbar.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_species_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If species_list is none then the labels are just elements</span>
            <span class="n">species_name</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">atomic_number2element_symbol</span><span class="p">(</span><span class="n">atomic_num</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">atomic_num</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">species_name</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
                <span class="c1"># Go through each species requested</span>
                <span class="n">ion_number</span> <span class="o">=</span> <span class="n">species</span> <span class="o">%</span> <span class="mi">100</span>
                <span class="n">atomic_number</span> <span class="o">=</span> <span class="p">(</span><span class="n">species</span> <span class="o">-</span> <span class="n">ion_number</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>

                <span class="n">ion_numeral</span> <span class="o">=</span> <span class="n">int_to_roman</span><span class="p">(</span><span class="n">ion_number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">atomic_symbol</span> <span class="o">=</span> <span class="n">atomic_number2element_symbol</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)</span>

                <span class="c1"># if the element was requested, and not a specific ion, then</span>
                <span class="c1"># add the element symbol to the label list</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">atomic_number</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_colour</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                    <span class="n">atomic_symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">species_name</span>
                <span class="p">):</span>
                    <span class="c1"># compiling the label, and adding it to the list</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atomic_symbol</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">species_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">atomic_number</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_colour</span><span class="p">:</span>
                    <span class="c1"># otherwise add the ion to the label list</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atomic_symbol</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ion_numeral</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">species_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_species_name</span> <span class="o">=</span> <span class="n">species_name</span>

    <span class="k">def</span> <span class="nf">_make_colorbar_colors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the colours for the species to be plotted.&quot;&quot;&quot;</span>
        <span class="c1"># the colours depends on the species present in the model and what&#39;s requested</span>
        <span class="c1"># some species need to be shown in the same colour, so the exact colours have to be</span>
        <span class="c1"># worked out</span>

        <span class="n">color_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Colors for each element</span>
        <span class="c1"># Create new variables to keep track of the last atomic number that was plotted</span>
        <span class="c1"># This is used when plotting species in case an element was given in the list</span>
        <span class="c1"># This is to ensure that all ions of that element are grouped together</span>
        <span class="c1"># ii is to track the colour index</span>
        <span class="c1"># e.g. if Si is given in species_list, this is to ensure Si I, Si II, etc. all have the same colour</span>
        <span class="n">color_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">previous_atomic_number</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">species_counter</span><span class="p">,</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_species_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Get the ion number and atomic number for each species</span>
                <span class="n">ion_number</span> <span class="o">=</span> <span class="n">identifier</span> <span class="o">%</span> <span class="mi">100</span>
                <span class="n">atomic_number</span> <span class="o">=</span> <span class="p">(</span><span class="n">identifier</span> <span class="o">-</span> <span class="n">ion_number</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>
                <span class="k">if</span> <span class="n">previous_atomic_number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># If this is the first species being plotted, then take note of the atomic number</span>
                    <span class="c1"># don&#39;t update the colour index</span>
                    <span class="n">color_counter</span> <span class="o">=</span> <span class="n">color_counter</span>
                    <span class="n">previous_atomic_number</span> <span class="o">=</span> <span class="n">atomic_number</span>
                <span class="k">elif</span> <span class="n">previous_atomic_number</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keep_colour</span><span class="p">:</span>
                    <span class="c1"># If the atomic number is in the list of elements that should all be plotted in the same colour</span>
                    <span class="c1"># then don&#39;t update the colour index if this element has been plotted already</span>
                    <span class="k">if</span> <span class="n">previous_atomic_number</span> <span class="o">==</span> <span class="n">atomic_number</span><span class="p">:</span>
                        <span class="n">color_counter</span> <span class="o">=</span> <span class="n">color_counter</span>
                        <span class="n">previous_atomic_number</span> <span class="o">=</span> <span class="n">atomic_number</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Otherwise, increase the colour counter by one, because this is a new element</span>
                        <span class="n">color_counter</span> <span class="o">=</span> <span class="n">color_counter</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">previous_atomic_number</span> <span class="o">=</span> <span class="n">atomic_number</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If this is just a normal species that was requested then increment the colour index</span>
                    <span class="n">color_counter</span> <span class="o">=</span> <span class="n">color_counter</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">previous_atomic_number</span> <span class="o">=</span> <span class="n">atomic_number</span>
                <span class="c1"># Calculate the colour of this species</span>
                <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">(</span><span class="n">color_counter</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_species_name</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If you&#39;re not using species list then this is just a fraction based on the total</span>
                <span class="c1"># number of columns in the dataframe</span>
                <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">(</span><span class="n">species_counter</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">))</span>

            <span class="n">color_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_color_list</span> <span class="o">=</span> <span class="n">color_list</span>

<div class="viewcode-block" id="SDECPlotter.generate_plot_ply"><a class="viewcode-back" href="../../../../api/tardis.visualization.tools.sdec_plot.html#tardis.visualization.tools.sdec_plot.SDECPlotter.generate_plot_ply">[docs]</a>    <span class="k">def</span> <span class="nf">generate_plot_ply</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">packets_mode</span><span class="o">=</span><span class="s2">&quot;virtual&quot;</span><span class="p">,</span>
        <span class="n">packet_wvl_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">observed_spectrum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">show_modeled_spectrum</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">graph_height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
        <span class="n">cmapname</span><span class="o">=</span><span class="s2">&quot;jet&quot;</span><span class="p">,</span>
        <span class="n">nelements</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">species_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate interactive Spectral element DEComposition (SDEC) Plot using plotly.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        packets_mode : {&#39;virtual&#39;, &#39;real&#39;}, optional</span>
<span class="sd">            Mode of packets to be considered, either real or virtual. Default</span>
<span class="sd">            value is &#39;virtual&#39;</span>
<span class="sd">        packet_wvl_range : astropy.Quantity or None, optional</span>
<span class="sd">            Wavelength range to restrict the analysis of escaped packets. It</span>
<span class="sd">            should be a quantity having units of Angstrom, containing two</span>
<span class="sd">            values - lower lambda and upper lambda i.e.</span>
<span class="sd">            [lower_lambda, upper_lambda] * u.AA. Default value is None</span>
<span class="sd">        distance : astropy.Quantity or None, optional</span>
<span class="sd">            Distance used to calculate flux instead of luminosity in the plot.</span>
<span class="sd">            It should have a length unit like m, Mpc, etc. Default value is None</span>
<span class="sd">        show_modeled_spectrum : bool, optional</span>
<span class="sd">            Whether to show modeled spectrum in SDEC Plot. Default value is</span>
<span class="sd">            True</span>
<span class="sd">        fig : plotly.graph_objs._figure.Figure or None, optional</span>
<span class="sd">            Figure object on which to create plot. Default value is None which</span>
<span class="sd">            will create plot on a new Figure object.</span>
<span class="sd">        graph_height : int, optional</span>
<span class="sd">            Height (in px) of the plotly graph to display. Default value is 600</span>
<span class="sd">        cmapname : str, optional</span>
<span class="sd">            Name of the colormap to be used for showing elements.</span>
<span class="sd">            Default value is &quot;jet&quot;</span>
<span class="sd">        nelements: int</span>
<span class="sd">            Number of elements to include in plot. Determined by the</span>
<span class="sd">            largest contribution to total luminosity absorbed and emitted.</span>
<span class="sd">            Other elements are shown in silver. Default value is</span>
<span class="sd">            None, which displays all elements</span>
<span class="sd">        species_list: list of strings or None</span>
<span class="sd">            list of strings containing the names of species that should be included in the SDEC plots.</span>
<span class="sd">            Must be given in Roman numeral format. Can include specific ions, a range of ions,</span>
<span class="sd">            individual elements, or any combination of these:</span>
<span class="sd">            e.g. [&#39;Si II&#39;, &#39;Ca II&#39;, &#39;C&#39;, &#39;Fe I-V&#39;]</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plotly.graph_objs._figure.Figure</span>
<span class="sd">            Figure object on which SDEC Plot is created</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># If species_list and nelements requested, tell user that nelements is ignored</span>
        <span class="k">if</span> <span class="n">species_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nelements</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Both nelements and species_list were requested. Species_list takes priority; nelements is ignored&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Parse the requested species list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_species_list</span><span class="p">(</span><span class="n">species_list</span><span class="o">=</span><span class="n">species_list</span><span class="p">)</span>

        <span class="c1"># Calculate data attributes required for plotting</span>
        <span class="c1"># and save them in instance itself</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_plotting_data</span><span class="p">(</span>
            <span class="n">packets_mode</span><span class="o">=</span><span class="n">packets_mode</span><span class="p">,</span>
            <span class="n">packet_wvl_range</span><span class="o">=</span><span class="n">packet_wvl_range</span><span class="p">,</span>
            <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
            <span class="n">nelements</span><span class="o">=</span><span class="n">nelements</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">fig</span>

        <span class="c1"># Get the labels in the color bar. This determines the number of unique colors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_colorbar_labels</span><span class="p">()</span>
        <span class="c1"># Set colormap to be used in elements of emission and absorption plots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmapname</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_species_name</span><span class="p">))</span>
        <span class="c1"># Get the number of unique colors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_make_colorbar_colors</span><span class="p">()</span>

        <span class="c1"># Plot absorption and emission components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_emission_ply</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_absorption_ply</span><span class="p">()</span>

        <span class="c1"># Plot modeled spectrum</span>
        <span class="k">if</span> <span class="n">show_modeled_spectrum</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modeled_spectrum_luminosity</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
                    <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                        <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">packets_mode</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> Spectrum&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Plot photosphere</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">photosphere_luminosity</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s2">&quot;dash&quot;</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Blackbody Photosphere&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_show_colorbar_ply</span><span class="p">()</span>

        <span class="c1"># Set label and other layout options</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">axis_label_in_latex</span><span class="p">(</span><span class="s2">&quot;Wavelength&quot;</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">AA</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">distance</span><span class="p">:</span>  <span class="c1"># Set y-axis label for flux</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">axis_label_in_latex</span><span class="p">(</span>
                <span class="s2">&quot;F_{</span><span class="se">\\</span><span class="s2">lambda}&quot;</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;erg/(s cm**2 AA)&quot;</span><span class="p">),</span> <span class="n">only_text</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Set y-axis label for luminosity</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">axis_label_in_latex</span><span class="p">(</span>
                <span class="s2">&quot;L_{</span><span class="se">\\</span><span class="s2">lambda}&quot;</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">Unit</span><span class="p">(</span><span class="s2">&quot;erg/(s AA)&quot;</span><span class="p">),</span> <span class="n">only_text</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span>
                <span class="n">exponentformat</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">exponentformat</span><span class="o">=</span><span class="s2">&quot;e&quot;</span><span class="p">),</span>
            <span class="n">height</span><span class="o">=</span><span class="n">graph_height</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span></div>

<div class="viewcode-block" id="SDECPlotter.to_rgb255_string"><a class="viewcode-back" href="../../../../api/tardis.visualization.tools.sdec_plot.html#tardis.visualization.tools.sdec_plot.SDECPlotter.to_rgb255_string">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">to_rgb255_string</span><span class="p">(</span><span class="n">color_tuple</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a matplotlib RGBA tuple to a generic RGB 255 string.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        color_tuple : tuple</span>
<span class="sd">            Matplotlib RGBA tuple of float values in closed interval [0, 1]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            RGB string of format rgb(r,g,b) where r,g,b are integers between</span>
<span class="sd">            0 and 255 (both inclusive)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">color_tuple_255</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">color_tuple</span><span class="p">[:</span><span class="mi">3</span><span class="p">]])</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;rgb</span><span class="si">{</span><span class="n">color_tuple_255</span><span class="si">}</span><span class="s2">&quot;</span></div>

    <span class="k">def</span> <span class="nf">_plot_emission_ply</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot emission part of the SDEC Plot using plotly.&quot;&quot;&quot;</span>
        <span class="c1"># By specifying a common stackgroup, plotly will itself add up</span>
        <span class="c1"># luminosities, in order, to created stacked area chart</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="o">.</span><span class="n">noint</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;No interaction&quot;</span><span class="p">,</span>
                <span class="n">fillcolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">stackgroup</span><span class="o">=</span><span class="s2">&quot;emission&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="o">.</span><span class="n">escatter</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Electron Scatter Only&quot;</span><span class="p">,</span>
                <span class="n">fillcolor</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
                <span class="n">stackgroup</span><span class="o">=</span><span class="s2">&quot;emission&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># If &#39;other&#39; column exists then plot as silver</span>
        <span class="k">if</span> <span class="s2">&quot;other&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="o">.</span><span class="n">other</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Other elements&quot;</span><span class="p">,</span>
                    <span class="n">fillcolor</span><span class="o">=</span><span class="s2">&quot;silver&quot;</span><span class="p">,</span>
                    <span class="n">stackgroup</span><span class="o">=</span><span class="s2">&quot;emission&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Contribution from each element</span>
        <span class="k">for</span> <span class="n">species_counter</span><span class="p">,</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                        <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">emission_luminosities_df</span><span class="p">[</span><span class="n">identifier</span><span class="p">],</span>
                        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                        <span class="n">fillcolor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">to_rgb255_string</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_color_list</span><span class="p">[</span><span class="n">species_counter</span><span class="p">]</span>
                        <span class="p">),</span>
                        <span class="n">stackgroup</span><span class="o">=</span><span class="s2">&quot;emission&quot;</span><span class="p">,</span>
                        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># Add notifications that this species was not in the emission df</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_species_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atomic_number2element_symbol</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; is not in the emitted packets; skipping&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Get the ion number and atomic number for each species</span>
                    <span class="n">ion_number</span> <span class="o">=</span> <span class="n">identifier</span> <span class="o">%</span> <span class="mi">100</span>
                    <span class="n">atomic_number</span> <span class="o">=</span> <span class="p">(</span><span class="n">identifier</span> <span class="o">-</span> <span class="n">ion_number</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atomic_number2element_symbol</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">int_to_roman</span><span class="p">(</span><span class="n">ion_number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; is not in the emitted packets; skipping&quot;</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_plot_absorption_ply</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot absorption part of the SDEC Plot using plotly.&quot;&quot;&quot;</span>

        <span class="c1"># If &#39;other&#39; column exists then plot as silver</span>
        <span class="k">if</span> <span class="s2">&quot;other&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">absorption_luminosities_df</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">absorption_luminosities_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                    <span class="c1"># to plot absorption luminosities along negative y-axis</span>
                    <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">absorption_luminosities_df</span><span class="o">.</span><span class="n">other</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Other elements&quot;</span><span class="p">,</span>
                    <span class="n">fillcolor</span><span class="o">=</span><span class="s2">&quot;silver&quot;</span><span class="p">,</span>
                    <span class="n">stackgroup</span><span class="o">=</span><span class="s2">&quot;absorption&quot;</span><span class="p">,</span>
                    <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">species_counter</span><span class="p">,</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">absorption_luminosities_df</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                        <span class="c1"># to plot absorption luminosities along negative y-axis</span>
                        <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">absorption_luminosities_df</span><span class="p">[</span><span class="n">identifier</span><span class="p">]</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                        <span class="n">fillcolor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">to_rgb255_string</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_color_list</span><span class="p">[</span><span class="n">species_counter</span><span class="p">]</span>
                        <span class="p">),</span>
                        <span class="n">stackgroup</span><span class="o">=</span><span class="s2">&quot;absorption&quot;</span><span class="p">,</span>
                        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># Add notifications that this species was not in the emission df</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_species_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atomic_number2element_symbol</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; is not in the absorbed packets; skipping&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Get the ion number and atomic number for each species</span>
                    <span class="n">ion_number</span> <span class="o">=</span> <span class="n">identifier</span> <span class="o">%</span> <span class="mi">100</span>
                    <span class="n">atomic_number</span> <span class="o">=</span> <span class="p">(</span><span class="n">identifier</span> <span class="o">-</span> <span class="n">ion_number</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atomic_number2element_symbol</span><span class="p">(</span><span class="n">atomic_number</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">int_to_roman</span><span class="p">(</span><span class="n">ion_number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; is not in the absorbed packets; skipping&quot;</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_show_colorbar_ply</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show plotly colorbar with labels of elements mapped to colors.&quot;&quot;&quot;</span>
        <span class="c1"># Interpolate [0, 1] range to create bins equal to number of elements</span>
        <span class="n">colorscale_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_species_name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create a categorical colorscale [a list of (reference point, color)]</span>
        <span class="c1"># by mapping same reference points (excluding 1st and last bin edge)</span>
        <span class="c1"># twice in a row (https://plotly.com/python/colorscales/#constructing-a-discrete-or-discontinuous-color-scale)</span>
        <span class="n">categorical_colorscale</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">species_counter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_species_name</span><span class="p">)):</span>
            <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_rgb255_string</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">(</span><span class="n">colorscale_bins</span><span class="p">[</span><span class="n">species_counter</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">categorical_colorscale</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">colorscale_bins</span><span class="p">[</span><span class="n">species_counter</span><span class="p">],</span> <span class="n">color</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">categorical_colorscale</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">colorscale_bins</span><span class="p">[</span><span class="n">species_counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">coloraxis_options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="n">categorical_colorscale</span><span class="p">,</span>
            <span class="n">showscale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">cmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">cmax</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_species_name</span><span class="p">),</span>
            <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Elements&quot;</span><span class="p">,</span>
                <span class="n">tickvals</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_species_name</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="n">ticktext</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_species_name</span><span class="p">,</span>
                <span class="c1"># to change length and position of colorbar</span>
                <span class="nb">len</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
                <span class="n">yanchor</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Plot an invisible one point scatter trace, to make colorbar show up</span>
        <span class="n">scatter_point_idx</span> <span class="o">=</span> <span class="n">pu</span><span class="o">.</span><span class="n">get_mid_point_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_wavelength</span><span class="p">[</span><span class="n">scatter_point_idx</span><span class="p">],</span>
                <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
                <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">opacity</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">coloraxis_options</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2013-2021, TARDIS Collaboration.
      <span class="lastupdated">
        Last updated on 12 Jul 2021.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>